services:
 catalogdb:
  container_name: catalogdb
  environment:
   - POSTGRES_USER=postgres
   - POSTGRES_PASSWORD=postgres
   - POSTGRES_DB=CatalogDb
  restart: always
  ports:
   - "5432:5432"
  volumes:
   - postgres_catalog:/var/lib/postgresql/data/
  healthcheck:
   test: ["CMD-SHELL", "pg_isready -U postgres"]
   interval: 5s
   timeout: 5s
   retries: 5

 basketdb:
  container_name: basketdb
  environment:
   - POSTGRES_USER=postgres
   - POSTGRES_PASSWORD=postgres
   - POSTGRES_DB=BasketDb
  restart: always
  ports:
   - "5433:5432"
  volumes:
   - postgres_basket:/var/lib/postgresql/data/
  healthcheck:
   test: ["CMD-SHELL", "pg_isready -U postgres"]
   interval: 5s
   timeout: 5s
   retries: 5

 distributedcache:
  container_name: distributedcache
  restart: always
  ports:
   - "6379:6379"
  healthcheck:
   test: ["CMD", "redis-cli", "ping"]
   interval: 5s
   timeout: 3s
   retries: 5

 catalog.api:
  environment:
    - ASPNETCORE_ENVIRONMENT=Development
    - ASPNETCORE_HTTP_PORTS=8080
    # - ASPNETCORE_HTTPS_PORTS=8081
    - ConnectionStrings__DefaultConnection=Host=catalogdb;Port=5432;Database=CatalogDb;Username=postgres;Password=postgres
  depends_on:
   catalogdb:
    condition: service_healthy
  ports:
    - "5000:8080"
    - "5050:8081"
  volumes:
    - ${APPDATA}/Microsoft/UserSecrets:/home/app/.microsoft/usersecrets:ro
    - ${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:ro
    - ${APPDATA}/ASP.NET/Https:/home/app/.aspnet/https:ro
    - ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro

 basket.api:
  environment:
   - ASPNETCORE_ENVIRONMENT=Development
   - ASPNETCORE_HTTP_PORTS=8080
   # - ASPNETCORE_HTTPS_PORTS=8081
   - ConnectionStrings__DefaultConnection=Host=basketdb;Port=5432;Database=BasketDb;Username=postgres;Password=postgres
   - ConnectionStrings__RedisConnection=distributedcache:6379
   - gRPCSetting__DiscountUrl=discount.grpc:8080
  depends_on:
   basketdb: 
    condition: service_healthy
   distributedcache :
    condition: service_healthy 
  ports:
   - "5001:8080"
   - "5051:8081"
  volumes:
   - ${APPDATA}/Microsoft/UserSecrets:/home/app/.microsoft/usersecrets:ro
   - ${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:ro
   - ${APPDATA}/ASP.NET/Https:/home/app/.aspnet/https:ro
   - ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro

 discount.grpc:
  environment:
    - ASPNETCORE_ENVIRONMENT=Development
    - ASPNETCORE_HTTP_PORTS=8080
    # - ASPNETCORE_HTTPS_PORTS=8081
    - ConnectionStrings__sqlite=Data Source=discountdb
  ports:
    - "5002:8080"
    - "5052:8081"
  volumes:
    - ${APPDATA}/Microsoft/UserSecrets:/home/app/.microsoft/usersecrets:ro
    - ${APPDATA}/Microsoft/UserSecrets:/root/.microsoft/usersecrets:ro
    - ${APPDATA}/ASP.NET/Https:/home/app/.aspnet/https:ro
    - ${APPDATA}/ASP.NET/Https:/root/.aspnet/https:ro
